---
title: "Analiza mieszkań na obszarze miasta Gdańsk"
author: "Veronika Krasnianska, Olena Dovhopola"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: cayman
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
  message = FALSE,
	fig.align = "center",
	fig.retina = 2,
	warning = FALSE,
	dpi = 150,
	out.width = "90%"
)
css <- "
.main-content img {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.main-content .figure,
.main-content figure {
  text-align: center;
}

.main-content table {
  margin-left: auto;
  margin-right: auto;
}

.main-content .html-widget {
  display: block;
  margin-left: auto !important;
  margin-right: auto !important;
}

.main-content .html-widget > div,
.main-content .html-widget iframe {
  margin-left: auto !important;
  margin-right: auto !important;
}
"

writeLines(css, "styles.css")
```

```{r lib, warning=FALSE, include=FALSE}
library(tidyverse)
library(validate)
library(readr)
library(dplyr)
library(naniar)
library(finalfit)
library(mice)
library(ggplot2)
library(kableExtra)
library(summarytools)
library(ggridges)
library(gtsummary)
library(frequency)
library(corrplot)
library(ggpubr)
library(skimr)
library(leaflet)
library(leaflet.extras)
library(tidyr)
library(gt)
library(ggstatsplot)
library(ggcorrplot)
library(rstatix)
library(modelsummary)
library(car)
library(sandwich)
library(lmtest)
```

## Wprowadzenie

Rynek nieruchomości mieszkaniowych w dużych miastach charakteryzuje się wysokim stopniem złożoności oraz znacznym zróżnicowaniem cen i cech oferowanych lokali. Na poziom cen mieszkań wpływają jednocześnie czynniki lokalizacyjne, strukturalne oraz związane ze standardem technicznym nieruchomości, a ich oddziaływanie często ma charakter nieliniowy i wzajemnie powiązany. W konsekwencji analiza rynku mieszkaniowego wymaga zastosowania zarówno metod eksploracyjnych, jak i narzędzi analizy statystycznej oraz ekonometrycznej.

Miasto Gdańsk, jako jeden z głównych ośrodków miejskich w Polsce, stanowi interesujący obszar badań ze względu na dynamiczny rozwój urbanistyczny, zróżnicowaną strukturę przestrzenną oraz silne kontrasty pomiędzy centralnymi i peryferyjnymi lokalizacjami. Istotną rolę w kształtowaniu cen mieszkań odgrywa tu dostępność infrastruktury miejskiej, bliskość centrum, zagęszczenie punktów usługowych oraz standard techniczny budynków i lokali. Celem niniejszego projektu jest empiryczna analiza rynku mieszkań w Gdańsku z wykorzystaniem metod analizy danych dostępnych w środowisku R. Badanie obejmuje eksploracyjną analizę danych, ocenę rozkładów kluczowych zmiennych, identyfikację zależności korelacyjnych oraz zastosowanie testów nieparametrycznych i modeli regresji hedonicznej. Szczególny nacisk położono na ocenę wpływu lokalizacji (mierzonej m.in. odległością od centrum miasta) oraz standardu technicznego mieszkań na poziom cen, zarówno całkowitych, jak i cen za metr kwadratowy.

## Cel analizy 

Celem analizy jest ocena wpływu lokalizacji oraz standardu technicznego mieszkań na poziom cen na rynku mieszkaniowym w Gdańsku. W szczególności badanie koncentruje się na relacji pomiędzy odległością mieszkania od centrum miasta a ceną oraz na sprawdzeniu, czy wybrane cechy standardu technicznego modyfikują tę zależność. W związku z tym sformułowano następujące pytania badawcze i odpowiadające im hipotezy:

H1. Wzrost odległości mieszkania od centrum miasta wiąże się ze spadkiem cen mieszkań oraz cen za metr kwadratowy. Hipoteza ta odzwierciedla klasyczne podejście ekonomiczne, zgodnie z którym atrakcyjność lokalizacji centralnych znajduje odzwierciedlenie w wyższych cenach nieruchomości.

H2. Mieszkania posiadające wybrane cechy wyższego standardu technicznego (takie jak winda, ochrona, miejsce parkingowe, balkon czy komórka lokatorska) osiągają istotnie wyższe ceny za metr kwadratowy niż mieszkania pozbawione tych udogodnień. Hipoteza ta testowana jest z wykorzystaniem nieparametrycznych testów porównawczych, ze względu na skośne rozkłady cen.

H3. Siła i kierunek zależności pomiędzy odległością od centrum a ceną za metr kwadratowy różnią się w zależności od standardu technicznego mieszkania. Hipoteza ta zakłada, że standard techniczny może modyfikować znaczenie lokalizacji, co badane jest poprzez porównanie korelacji w grupach mieszkań o różnym standardzie oraz poprzez zastosowanie interakcji w modelu regresji hedonicznej.

H4. Metraż mieszkania jest dodatnio związany z ceną całkowitą oraz jednocześnie ujemnie związany z ceną za metr kwadratowy. Hipoteza ta odzwierciedla efekt skali, zgodnie z którym większe mieszkania są droższe w ujęciu bezwzględnym, lecz tańsze w przeliczeniu na jednostkę powierzchni.

## Przygotowywanie danych do analizy

W pierwszym kroku wczytano zbiór danych , a następnie ograniczono obserwacje wyłącznie do mieszkań zlokalizowanych w mieście Gdańsk. Następnie sprawdzono występowanie duplikatów rekordów przy użyciu funkcji. W analizowanym podzbiorze nie stwierdzono duplikatów, co oznacza, że każda obserwacja odpowiada unikalnej ofercie.

Kolejnym etapem było wstępne uporządkowanie struktury danych poprzez usunięcie zmiennych, które nie są wykorzystywane w dalszej analizie (id, condition, buildingMaterial, city). Dodatkowo wszystkie zmienne zapisane jako tekst (character) zostały przekonwertowane do typu faktor , co ułatwia późniejszą analizę zmiennych jakościowych oraz modelowanie z wykorzystaniem zmiennych kategorycznych.

Na końcu utworzono zmienną pochodną price_m2, definiowaną jako cena mieszkania w przeliczeniu na metr kwadratowy (price / squareMeters). Dzięki temu w analizie możliwe jest równoległe badanie cen w ujęciu całkowitym (price) oraz w ujęciu jednostkowym (price_m2), co jest szczególnie istotne w kontekście porównań mieszkań o różnej powierzchni.

```{r warning=FALSE, include=FALSE}
dane<-read_csv("apartments_pl_2024_06.csv")
dane<-filter(dane, city=="gdansk")
sum(duplicated(dane))#  brak duplikatów-> mozna usunąć kolumne id i iine nie potrzebne kolumny
# takie wstępne przygotowanie danych
dane_gdansk <- dane %>%
  select(-c(id, condition, buildingMaterial,city))%>%
  mutate(across(where(is.character),as.factor))%>%
  mutate(price_m2 = price / squareMeters)
# slowniki do etykietowania zmiennych 
var_labels <- c(
  type = "Typ budynku",
  squareMeters = "Powierzchnia mieszkania [m²]",
  rooms = "Liczba pokoi",
  floor = "Piętro",
  floorCount = "Liczba kondygnacji w budynku",
  buildYear = "Rok budowy",
  latitude = "Szerokość geograficzna",
  longitude = "Długość geograficzna",
  centreDistance = "Odległość od centrum [km]",
  poiCount = "Liczba punktów POI w pobliżu",
  schoolDistance = "Odległość do szkoły [km]",
  clinicDistance = "Odległość do przychodni [km]",
  postOfficeDistance = "Odległość do poczty [km]",
  kindergartenDistance = "Odległość do przedszkola [km]",
  restaurantDistance = "Odległość do restauracji [km]",
  collegeDistance = "Odległość do uczelni [km]",
  pharmacyDistance = "Odległość do apteki [km]",
  ownership = "Forma własności",
  hasParkingSpace = "Miejsce parkingowe",
  hasBalcony = "Balkon",
  hasElevator = "Winda",
  hasSecurity = "Ochrona",
  hasStorageRoom = "Komórka lokatorska",
  price = "Cena całkowita [PLN]",
  price_m2 = "Cena za metr kwadratowy [PLN/m²]"
)
var_labels <- as.list(var_labels)
label_vars <- function(x) {
  sapply(as.character(x), function(v) var_labels[[v]])
}
```

### Kontrola jakości danych i reguły walidacyjne

Przed przeprowadzeniem dalszych analiz statystycznych i ekonometrycznych dokonano oceny jakości danych oraz identyfikacji potencjalnych niespójności logicznych w zbiorze. W pierwszym kroku przeanalizowano występowanie braków danych dla poszczególnych zmiennych. Pozwoliło to określić, w których zmiennych brakujące obserwacje występują i powinny zostać dopuszczone w regułach walidacyjnych.

**Reguły twarde**

Reguły twarde opisują warunki, które muszą być spełnione, aby obserwacja była uznana za logicznie poprawną. Obejmują one przede wszystkim ograniczenia zakresów wartości zmiennych oraz podstawowe zależności pomiędzy cechami mieszkań. Dla zmiennych, w których stwierdzono występowanie braków danych, reguły zostały skonstruowane w taki sposób, aby wartości NA były traktowane jako dopuszczalne.

W ramach reguł twardych zweryfikowano m.in.:

-   powierzchnię mieszkania, ograniczając ją do realistycznego zakresu (0–250 m²),

-   liczbę pokoi, przyjmując wartości od 1 do 8,

-   spójność metrażu i liczby pokoi, zakładając minimalną i maksymalną powierzchnię przypadającą na jeden pokój,

-   relacje pomiędzy piętrem a liczbą kondygnacji w budynku,

-   rok budowy budynku, ograniczony do lat 1850–2025,

-   odległości od punktów usługowych i centrum miasta, wykluczając wartości ujemne oraz skrajnie wysokie,

-   liczbę punktów POI w otoczeniu mieszkania,

-   poprawność kategorii zmiennych jakościowych, takich jak typ budynku, forma własności oraz obecność udogodnień,

-   realistyczny zakres cen za metr kwadratowy, ograniczony do przedziału 8 000–35 000 PLN/m².

Zastosowanie reguł twardych pozwoliło na identyfikację obserwacji naruszających podstawowe założenia logiczne lub ekonomiczne. 

**Reguły miękkie**

Oprócz reguł twardych zdefiniowano również reguły miękkie, które nie dyskwalifikują obserwacji, lecz wskazują na potencjalnie nietypowe lub mało prawdopodobne kombinacje cech. Reguły te mają charakter heurystyczny i opierają się na wiedzy domenowej dotyczącej rynku nieruchomości.

Do reguł miękkich zaliczono m.in.:

-   budynki sprzed 1945 roku o bardzo dużej liczbie kondygnacji,

-   brak windy w wysokich budynkach wybudowanych po 1995 roku,

-   nietypowe relacje pomiędzy metrażem a liczbą pokoi (np. bardzo małe mieszkania z dużą liczbą pokoi lub bardzo duże mieszkania jednopokojowe).

Reguły miękkie służą wyłącznie do sygnalizowania obserwacji odstających pod względem logicznym i nie są podstawą do automatycznego usuwania danych. Ich celem jest wsparcie decyzji analitycznych na dalszych etapach analizy.

```{r warning=FALSE, include=FALSE}
rules_hard <- validator(

  squareMeters > 0,
  squareMeters <= 250,

  rooms >= 1,
  rooms <= 8,         

  squareMeters >= rooms * 8,      
  squareMeters <= rooms * 40,     

  floor >= 0 | is.na(floor),     
  floorCount >= 1 | is.na(floorCount),
  floor <= floorCount | is.na(floor) | is.na(floorCount),

  buildYear >= 1850 | is.na(buildYear),
  buildYear <= 2025 | is.na(buildYear),
  
  centreDistance >= 0,
  schoolDistance >= 0 | is.na(schoolDistance),
  clinicDistance >= 0 | is.na(clinicDistance),
  postOfficeDistance >= 0 | is.na(postOfficeDistance),
  kindergartenDistance >= 0 | is.na(kindergartenDistance),
  restaurantDistance >= 0 | is.na(restaurantDistance),
  collegeDistance >= 0 | is.na(collegeDistance),
  pharmacyDistance >= 0 | is.na(pharmacyDistance),

  centreDistance <= 20,
  schoolDistance <= 10 | is.na(schoolDistance),
  clinicDistance <= 10 | is.na(clinicDistance),
  postOfficeDistance <= 10 | is.na(postOfficeDistance),
  kindergartenDistance <= 10 | is.na(kindergartenDistance),
  restaurantDistance <= 10 | is.na(restaurantDistance),
  collegeDistance <= 15 | is.na(collegeDistance),
  pharmacyDistance <= 10 | is.na(pharmacyDistance),

  poiCount >= 0,
  poiCount <= 300,               

  type %in% c("tenement","blockOfFlats","apartmentBuilding") | is.na(type),
  ownership %in% c("condominium","cooperative"),

  hasParkingSpace %in% c("yes","no"),
  hasBalcony %in% c("yes","no"),
  hasElevator %in% c("yes","no") | is.na(hasElevator),
  hasSecurity %in% c("yes","no"),
  hasStorageRoom %in% c("yes","no"),

  price > 0,
  price / squareMeters >= 8000,
  price / squareMeters <= 35000
)
out_hard <- confront(dane_gdansk, rules_hard)
summary(out_hard)
out <- confront(dane_gdansk, rules_hard)
summary(out)
summary(out_hard)$fails

rules_soft <- validator(

  !(buildYear < 1945 & floorCount > 7) | is.na(buildYear) | is.na(floorCount),
  !(floor >= 5 & buildYear >= 1995 & hasElevator == "no") | is.na(floor) | is.na(buildYear) | is.na(hasElevator),
  !(squareMeters < 35 & rooms >= 3),
  !(squareMeters > 80 & rooms == 1)
)
out_soft <- confront(dane_gdansk, rules_soft)
summary(out_soft)
summary(out_soft)$fails

```

W kolejnym etapie analizy przeprowadzono identyfikację wartości odstających dla zmiennych numerycznych z wykorzystaniem metody opartej na rozstępie międzykwartylowym (IQR). Do analizy wybrano wyłącznie zmienne o charakterze liczbowym, co pozwoliło na jednolite zastosowanie kryterium statystycznego.

Dla każdej zmiennej obliczono pierwszy kwartyl (Q1), trzeci kwartyl (Q3) oraz wartość IQR, a następnie określono odsetek obserwacji wykraczających poza przedział $$Q1 - 1.5 \cdot IQR$$
$$Q3 + 1.5 \cdot IQR$$
Wynik przedstawiono jako procent obserwacji odstających w danej zmiennej.

```{r  warning=FALSE, include=FALSE}
# wybór zmiennych numerycznych
num_vars <- dane_gdansk %>% select(where(is.numeric))

iqr_outliers <- num_vars %>%
  summarise(across(
    everything(),
    ~ {
      q1 <- quantile(.x, 0.25, na.rm = TRUE)
      q3 <- quantile(.x, 0.75, na.rm = TRUE)
      iqr <- IQR(.x, na.rm = TRUE)
      mean(.x < (q1 - 1.5 * iqr) | .x > (q3 + 1.5 * iqr), na.rm = TRUE) * 100})) %>%
  pivot_longer(
    everything(),
    names_to = "variable",
    values_to = "pct_outliers") %>%
  arrange(desc(pct_outliers))
```

```{r warning=FALSE, results='asis', echo=FALSE}
kable(iqr_outliers %>%
        mutate(variable = label_vars(variable))%>%
        mutate(pct_outliers = round(pct_outliers, 2)) %>%
        filter(pct_outliers!= 0),
      format = "html", digits = 2,caption = "Identyfikacja wartości odstających (IQR)",col.names = c("Zmienna", "% obserwacji odstających")) %>%
kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

```

Najwięcej wartości odstających dotyczy zmiennych przestrzennych i strukturalnych (liczba kondygnacji, POI, odległości), co wynika z naturalnego zróżnicowania zabudowy i lokalizacji w Gdańsku. Zmienne cenowe, zwłaszcza cena za m², charakteryzują się niskim udziałem outlierów, co potwierdza ich stabilność analityczną. Wartości odstające mają charakter merytoryczny, dlatego nie zostały usunięte z analizy.

### Analiza braków danych i imputacja

W niniejszym podrozdziale przeprowadzono analizę występowania braków danych w zbiorze ofert mieszkaniowych zlokalizowanych w Gdańsku. Celem tego etapu było określenie zakresu i struktury braków danych oraz ocena ich potencjalnego wpływu na dalszą analizę statystyczną.

```{r warning=FALSE, results='asis', echo=FALSE}
miss_var_summary(dane_gdansk) |>
  slice(1:12) |>
  rename(
    Zmienna = variable,
    `Liczba braków` = n_miss,
    `Udział braków [%]` = pct_miss
  ) |>
  gt() |>
  tab_header(
    title = "Występowanie braków danych",
    subtitle = "Podsumowanie dla zmiennych w zbiorze danych (niezaznaczone zmienne nie posiadają braków danych)"
  ) |>
  fmt_number(
    columns = `Udział braków [%]`,
    decimals = 2
  )
```

```{r warning=FALSE, results='asis', echo=FALSE}
mcar_test(dane_gdansk) %>%
  transmute(
    `Statystyka χ²` = round(statistic, 2),
    `Stopnie swobody` = df,
    `Wartość p` = p.value,
    `Liczba wzorców braków danych` = missing.patterns
  ) %>%
  kable(
    format = "html",
    caption = "Wyniki testu MCAR (Little’a)",
    align = "c"
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover"),
    full_width = FALSE,
    position = "center"
  )
```

Wynik testu MCAR (Little’a) wskazuje na odrzucenie hipotezy o całkowicie losowym mechanizmie braków danych (p \< 0,001).

```{r warning=FALSE, results='asis', echo=FALSE}
gg_miss_upset(dane_gdansk)
```

Wizualizacja braków danych potwierdza, że braki występują jedynie w wybranych zmiennych i mają ograniczony zakres. Rozkład braków danych jest spójny z wynikami analizy tabelarycznej i nie wskazuje na koncentrację braków w jednej lub kilku kluczowych zmiennych.

Ze względu na nielosowy charakter braków oraz ich koncentrację w wybranych zmiennych, do uzupełnienia danych zastosowano metodę imputacji wielokrotnej MICE. Metoda ta pozwala odtworzyć brakujące wartości w sposób zgodny z zależnościami występującymi w zbiorze, ograniczając ryzyko zniekształcenia wyników dalszej analizy. Zmienne o minimalnej liczbie braków pozostawiono bez imputacji, gdyż ich wpływ na modele jest pomijalny. Dzięki przeprowadzonej imputacji uzyskano kompletny i spójny zbiór danych, odpowiedni do kolejnych etapów modelowania.

```{r warning=FALSE, include=FALSE}
methods <- make.method(dane_gdansk)
methods[] <- ""

methods["floor"]           <- "pmm"
methods["buildYear"]       <- "pmm"
methods["hasElevator"]     <- "logreg"
methods["collegeDistance"] <- "pmm"
methods["type"]            <- ""   

pred <- make.predictorMatrix(dane_gdansk)
pred[,] <- 0
diag(pred) <- 0

pred["floor", c("floorCount","rooms","squareMeters","buildYear","hasElevator","poiCount")] <- 1
pred["buildYear", c("floorCount","centreDistance","poiCount","squareMeters","rooms")] <- 1
pred["hasElevator", c("floorCount","buildYear","floor")] <- 1
pred["collegeDistance", c("centreDistance","poiCount","latitude","longitude")] <- 1
pred[, "type"] <- 0
pred["type", ] <- 0

set.seed(123)
imp <- mice(dane_gdansk, method = methods, predictorMatrix = pred, m = 5, maxit = 20, ridge = 1e-5)
dane_imputed <- complete(imp, 1)

```

Braki danych uzupełniono metodą wielokrotnej imputacji MICE, dobierając modele imputacji do charakteru zmiennych (PMM dla zmiennych liczbowych, regresja logistyczna dla binarnej zmiennej hasElevator). Macierz predyktorów ograniczono wyłącznie do zmiennych merytorycznie uzasadnionych, aby uniknąć sztucznych zależności i nadmiernego przeuczenia imputacji. Zmienna type została celowo wyłączona z procesu imputacji. Ostateczny zbiór danych uzyskano po pięciu imputacjach, wybierając jedną kompletną realizację do dalszej analizy.

```{r warning=FALSE, results='asis', echo=FALSE}
densityplot(imp, ~ floor)
```

Wykres przedstawia porównanie rozkładów wartości obserwowanych i imputowanych zmiennej piętro. Rozkłady po imputacji zachowują strukturę danych pierwotnych, bez widocznej koncentracji imputowanych wartości w pojedynczych punktach ani przesunięcia zakresu zmienności.

```{r warning=FALSE, results='asis', echo=FALSE}
densityplot(imp, ~ buildYear)
```

Wykres gęstości dla zmiennej rok budowy wskazuje, że imputowane wartości są zgodne z rozkładem obserwowanych danych. Nie zaobserwowano sztucznego wygładzenia ani generowania nierealistycznych wartości, co świadczy o poprawnym dopasowaniu procedury imputacji.

```{r warning=FALSE, results='asis', echo=FALSE}
densityplot(imp, ~ collegeDistance)
```

Porównanie rozkładów zmiennej odległość do uczelni pokazuje, że imputacja nie zniekształca charakteru danych przestrzennych. Rozkłady wartości imputowanych mieszczą się w zakresie danych obserwowanych i odzwierciedlają ich rzeczywistą zmienność.

## Analiza eksploracyjna danych

W niniejszym rozdziale przeprowadzono analizę eksploracyjną danych, koncentrując się na wizualizacji zależności pomiędzy ceną mieszkań a ich cechami ilościowymi, jakościowymi oraz lokalizacyjnymi, w tym rozmieszczeniu przestrzennym ofert.

### Wizualizacje

```{r warning=FALSE, results='asis', echo=FALSE}
dane_imputed %>%
  mutate(
    size_bin = cut(
      squareMeters,
      breaks = c(0, 30, 50, 70, 90, 120, Inf),
      labels = c("<30","30–50","50–70","70–90","90–120","120+")
    )
  ) %>%
  ggplot(aes(x = size_bin, y = price)) +
  geom_boxplot(fill = "#9ecae1") +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Rozkład cen mieszkań według przedziałów metrażu",
    x = "Metraż [m²]",
    y = "Cena [PLN]"
  ) +
  theme_minimal()
```

Ceny mieszkań rosną wraz z przechodzeniem do wyższych przedziałów metrażu, przy czym rozkłady w poszczególnych grupach wykazują rosnącą zmienność. Największe zróżnicowanie cen obserwowane jest dla mieszkań o dużej powierzchni.

```{r warning=FALSE, results='asis', echo=FALSE}
dane_imputed %>%
  mutate(
    centre_bin = cut(
      centreDistance,
      breaks = c(0, 1, 3, 5, 8, Inf),
      labels = c("≤1 km","1–3","3–5","5–8",">8")
    )
  ) %>%
  ggplot(aes(x = centre_bin, y = price_m2)) +
  geom_boxplot(fill = "#c7e9c0") +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Cena za m² w zależności od odległości od centrum",
    x = "Odległość od centrum",
    y = "Cena za m² [PLN]"
  ) +
  theme_minimal()
```

Wykres pokazuje wyraźny spadek mediany ceny za metr kwadratowy wraz ze wzrostem odległości od centrum miasta. Jednocześnie bliższe lokalizacje charakteryzują się większym rozrzutem cen, co sugeruje większą heterogeniczność ofert w centralnych obszarach.

```{r warning=FALSE, results='asis', echo=FALSE}
dane_imputed %>%
  filter(!is.na(floor), hasElevator %in% c("yes","no"))%>%
  mutate(
    floor_bin = cut(floor, breaks = c(-Inf,1,3,5,10,Inf),
                    labels = c("1","2–3","4–5","6–10","11+"))
  ) %>%
  ggplot(aes(x = floor_bin, y = price_m2, fill = hasElevator)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Znaczenie windy w zależności od piętra",
    x = "Piętro",
    y = "Cena za m² [PLN]",
    fill = "Winda"
  ) +
  theme_minimal()

```

Cena za metr kwadratowy rośnie wraz z numerem piętra, szczególnie w budynkach wyposażonych w windę. Różnice pomiędzy lokalami z windą i bez windy stają się bardziej widoczne na wyższych kondygnacjach.

```{r warning=FALSE, results='asis', echo=FALSE}
ggplot(dane_imputed, aes(x = hasBalcony, y = price_m2)) +
  geom_violin(fill = "#9ecae1", alpha = 0.7, trim = TRUE) +
  geom_boxplot(width = 0.1, fill = "white") +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Rozkład ceny za m² – balkon vs brak balkonu",
    x = "Balkon",
    y = "Cena za m² [PLN]"
  ) +
  theme_minimal()
```

Mieszkania z balkonem charakteryzują się wyższą medianą ceny za metr kwadratowy w porównaniu do lokali bez balkonu. Rozkłady wskazują również na większą zmienność cen w grupie mieszkań z balkonem. Różnice cen za m² pomiędzy mieszkaniami z balkonem i bez balkonu są relatywnie niewielkie w porównaniu z innymi czynnikami

```{r warning=FALSE, results='asis', echo=FALSE}
pal <- colorNumeric("viridis", domain = dane_imputed$price_m2, na.color = "transparent")

leaflet(dane_imputed) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(
    lng = ~longitude, lat = ~latitude,
    radius = 3,
    stroke = FALSE,
    fillOpacity = 0.6,
    color = ~pal(price_m2),
    clusterOptions = markerClusterOptions()
  ) %>%
  addLegend("bottomright", pal = pal, values = ~price_m2,
            title = "Cena za m² [PLN]", labFormat = labelFormat())

```

Zastosowanie mechanizmu klastrowania markerów umożliwia czytelne przedstawienie rozmieszczenia ofert w obszarach o dużym zagęszczeniu punktów. Wizualizacja ta pozwala na łatwiejszą identyfikację rejonów o wysokiej liczbie ogłoszeń oraz ocenę, czy wysokie i niskie ceny występują w sposób przestrzennie skupiony.

### Analiza opisowa zmiennych jakościowych

W niniejszym podrozdziale przeprowadzono analizę zmiennych jakościowych opisujących cechy techniczne mieszkań oraz elementy ich wyposażenia. Celem tej części analizy eksploracyjnej jest ocena kompletności danych, liczby kategorii oraz struktury częstości występowania poszczególnych cech, a także identyfikacja podstawowych zależności pomiędzy wybranymi zmiennymi jakościowymi.

```{r warning=FALSE, include=FALSE}
cat_vars <- c(
  "type","ownership","hasParkingSpace","hasBalcony",
  "hasElevator","hasSecurity","hasStorageRoom"
)

tab_cat_meta <- dane_imputed %>%
  select(all_of(cat_vars)) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "val") %>%
  group_by(variable) %>%
  summarise(
    liczba_obserwacji = n(),
    liczba_brakow = sum(is.na(val)),
    `%_kompletnosci` = round((1 - liczba_brakow / liczba_obserwacji) * 100, 1),
    liczba_kategorii = n_distinct(val, na.rm = TRUE),
    .groups = "drop"
  )
bin_vars <- c("hasParkingSpace","hasBalcony","hasElevator","hasSecurity","hasStorageRoom")

tab_bin <- dane_imputed %>%
  select(all_of(bin_vars)) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "val") %>%
  mutate(val = tolower(as.character(val))) %>%
  group_by(variable) %>%
  summarise(
    n = n(),
    missing = sum(is.na(val)),
    n_nonmiss = n - missing,
    yes_n = sum(val %in% c("yes"), na.rm = TRUE),
    yes_pct = round(yes_n / n_nonmiss * 100, 1),
    .groups = "drop"
  )
tab_bin_final <- tab_bin %>% select(variable, n_nonmiss, yes_n, yes_pct)

tab_cat_meta <- tab_cat_meta %>% mutate(variable = label_vars(variable))
tab_bin <- tab_bin_final %>% mutate(variable = label_vars(variable))
```

```{r warning=FALSE, results='asis', echo=FALSE}
kable(tab_cat_meta, format = "html", digits = 2, caption = "Statystyki opisowe zmiennych jakościowych", col.names = c("Zmienna", "Liczba obserwacji", "Liczba braków", "% kompletności", "Liczba kategorii")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

Tabela przedstawia liczbę obserwacji, braki danych, poziom kompletności oraz liczbę kategorii dla zmiennych jakościowych. Zmienne cechują się wysoką kompletnością, a liczba kategorii jest zgodna z ich charakterem, co wskazuje na dobrą jakość danych.

```{r warning=FALSE, results='asis', echo=FALSE}
kable(tab_bin_final,format = "html",digits = 2,caption = "Struktura zmiennych binarnych – udział odpowiedzi „tak”",col.names = c("Zmienna","Liczba obserwacji","Liczba „tak”","% „tak”")) %>%
  kable_styling(full_width = FALSE,bootstrap_options = c("striped", "hover"))
```

Zestawienie prezentuje udział odpowiedzi pozytywnych w zmiennych binarnych opisujących wyposażenie mieszkań. Widoczne zróżnicowanie częstości występowania poszczególnych udogodnień wskazuje na ich potencjalną rolę w dalszej analizie ofert.

### Analiza opisowa zmiennych ilościowych i dyskretnych

W niniejszym podrozdziale przedstawiono analizę opisową zmiennych ilościowych i dyskretnych wykorzystanych w dalszych etapach badania. Zaprezentowano podstawowe miary położenia, zróżnicowania oraz zakresy zmienności, co pozwala scharakteryzować strukturę danych przed przejściem do analizy wizualnej i wnioskowania statystycznego.

```{r warning=FALSE, include=FALSE}
# zmienne dyskretne 
tab_disc <- dane_imputed %>%
  select(c("rooms", "floor", "floorCount", "buildYear", "poiCount")) %>%
  skim()%>%
  # dplyr::filter(skim_type == "numeric") %>%
  dplyr::select(
    zmienna = skim_variable,
    complete_rate,
    mean = `numeric.mean`,
    sd   = `numeric.sd`,
    min  = `numeric.p0`,
    q1   = `numeric.p25`,
    median = `numeric.p50`,
    q3   = `numeric.p75`,
    max  = `numeric.p100`
  ) %>%
  mutate(complete_rate = round(complete_rate * 100, 1), zmienna = label_vars(zmienna))
# zmienne ciagle
cont_vars <- c("squareMeters","price","price_m2")
tab_num <- dane_imputed %>%
  select(all_of(cont_vars))%>%
  skim()%>%
  dplyr::select(
    zmienna = skim_variable,
    complete_rate,
    mean = `numeric.mean`,
    sd   = `numeric.sd`,
    min  = `numeric.p0`,
    q1   = `numeric.p25`,
    median = `numeric.p50`,
    q3   = `numeric.p75`,
    max  = `numeric.p100`
  ) %>%
  mutate(complete_rate = round(complete_rate * 100, 1), zmienna = label_vars(zmienna))
# zmienne odlegosciowe
  dist_vars <- c("centreDistance","schoolDistance","clinicDistance","postOfficeDistance",
               "kindergartenDistance","restaurantDistance","collegeDistance","pharmacyDistance")
tab_od <- dane_imputed %>%
  select(all_of(dist_vars)) %>%
  skim()%>%
  # dplyr::filter(skim_type == "numeric") %>%
  dplyr::select(
    zmienna = skim_variable,
    complete_rate,
    mean = `numeric.mean`,
    sd   = `numeric.sd`,
    min  = `numeric.p0`,
    q1   = `numeric.p25`,
    median = `numeric.p50`,
    q3   = `numeric.p75`,
    max  = `numeric.p100`
  ) %>%
  mutate(complete_rate = round(complete_rate * 100, 1), zmienna = label_vars(zmienna))
```

```{r warning=FALSE, results='asis', echo=FALSE}
kable(tab_disc, format = "html", digits = 2, caption = "Statystyki opisowe (zmienne dyscretne)", col.names = c("Zmienna", "% kompletności", "Średnia", "Odch. std.", "Min", "Q1", "Mediana", "Q3", "Max")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

Tabela prezentuje statystyki opisowe zmiennych dyskretnych, które cechują się niemal pełną kompletnością danych. Liczba pokoi i piętro mają niewielką zmienność i skoncentrowane rozkłady wokół wartości typowych dla mieszkań miejskich. Liczba kondygnacji oraz rok budowy wykazują większe zróżnicowanie, co odzwierciedla heterogeniczność zabudowy. Zmienna opisująca liczbę punktów POI w pobliżu charakteryzuje się bardzo dużym rozrzutem i prawostronną asymetrią, wskazując na silne zróżnicowanie lokalizacyjne ofert.

```{r warning=FALSE, results='asis', echo=FALSE}
kable(tab_num, format = "html", digits = 2, caption = "Statystyki opisowe (zmienne numeryczne)", col.names = c("Zmienna", "% kompletności", "Średnia", "Odch. std.", "Min", "Q1", "Mediana", "Q3", "Max")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

Tabela przedstawia statystyki opisowe zmiennych ilościowych i dyskretnych, dla których nie występują braki danych. Rozkład powierzchni mieszkań jest umiarkowanie zróżnicowany i prawostronnie asymetryczny. Ceny całkowite oraz ceny za metr kwadratowy charakteryzują się dużą zmiennością i wyraźną prawostronną asymetrią, co wskazuje na istotny wpływ drogich ofert na wartości średnie i uzasadnia dalszą analizę z wykorzystaniem miar pozycyjnych.

```{r warning=FALSE, staystyki, results='asis', echo=FALSE}
kable(tab_od, format = "html", digits = 2, caption = "Statystyki opisowe (zmienne odlegościowe)", col.names = c("Zmienna", "% kompletności", "Średnia", "Odch. std.", "Min", "Q1", "Mediana", "Q3", "Max")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

Tabela przedstawia statystyki opisowe zmiennych odległościowych, które charakteryzują się niemal pełną kompletnością danych. Odległość od centrum wykazuje największe zróżnicowanie spośród analizowanych zmiennych, co odzwierciedla przestrzenne rozproszenie ofert. Odległości do podstawowych usług i obiektów użyteczności publicznej są relatywnie niewielkie i skoncentrowane wokół niskich wartości, jednak w większości przypadków widoczna jest prawostronna asymetria rozkładów, wskazująca na obecność ofert położonych znacznie dalej od infrastruktury.

## Wnioskowanie statystyczne

W celu formalnej weryfikacji postawionych hipotez badawczych przeprowadzono wnioskowanie statystyczne z wykorzystaniem metod nieparametrycznych, adekwatnych do charakteru danych oraz obserwowanych rozkładów zmiennych. Analiza obejmuje ocenę zależności pomiędzy kluczowymi cechami mieszkań a ceną całkowitą oraz ceną za metr kwadratowy, a także porównanie poziomu cen pomiędzy grupami mieszkań różniącymi się standardem technicznym.

Zastosowano współczynnik korelacji rang Spearmana do badania zależności pomiędzy zmiennymi ilościowymi, takimi jak odległość od centrum oraz metraż mieszkania, a poziomem cen. Dodatkowo, w celu oceny różnic cenowych pomiędzy mieszkaniami z określonymi udogodnieniami a mieszkaniami ich pozbawionymi, wykorzystano test U Manna–Whitneya. Wyniki analiz zaprezentowano zarówno w formie tabelarycznej, jak i graficznej, co umożliwia ocenę siły, kierunku oraz istotności statystycznej badanych zależności.

```{r warning=FALSE, include=FALSE}
h1_results <- dane_imputed %>%
  cor_test(centreDistance, c(price, price_m2), method = "spearman")
h1_results
h4_results <- dane_imputed %>%
  cor_test(squareMeters, c(price, price_m2), method = "spearman")
h4_results
vars_cor <- dane_imputed %>% 
  select(centreDistance, squareMeters, price, price_m2)
cor_mat <- cor(vars_cor, method = "spearman", use = "complete.obs")
```

```{r warning=FALSE, results='asis', echo=FALSE}
ggcorrplot(cor_mat, lab = TRUE) +
  scale_x_discrete(labels = label_vars) +
  scale_y_discrete(labels = label_vars) +
  scale_fill_gradient2(
    low = "#2166ac",
    mid = "white",
    high = "#b2182b",
    midpoint = 0,
    limits = c(-1, 1)
  ) +
  labs(
    title = "Korelacje rang Spearmana"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    axis.title = element_blank(),
    plot.title = element_text(face = "bold"),
    legend.position = "none"
  )
```

Odległość od centrum jest słabo, ale jednoznacznie ujemnie skorelowana z ceną całkowitą i ceną za m², natomiast metraż jest silnie dodatnio skorelowany z ceną całkowitą i ujemnie z ceną za m². Potwierdza to klasyczne mechanizmy rynkowe i uzasadnia dalsze modelowanie log-cen.

```{r warning=FALSE, results='asis', echo=FALSE}
ggbetweenstats(
  data = dane_imputed,
  x = hasElevator,
  y = price_m2,
  type = "nonparametric",   
  conf.level = 0.95,
  xlab = "Winda",
  ylab = "Cena za m² [PLN]",
  title = "Cena za m² a obecność windy",
  caption = "Test U Manna–Whitneya"
)
```

Rysunek przedstawia rozkład cen za m² mieszkań z windą i bez windy wraz z wynikami testu U Manna–Whitneya, ilustrując istotną statystycznie różnicę pomiędzy grupami

```{r warning=FALSE, include=FALSE}
h2_wilcox <-  dane_imputed %>%
  select(price_m2, all_of(bin_vars)) %>%
  pivot_longer(
    cols = all_of(bin_vars),
    names_to = "feature",
    values_to = "group") %>%
  filter(group %in% c("yes", "no")) %>%
  group_by(feature) %>%
  wilcox_test(price_m2 ~ group) %>%
  add_significance("p") %>%
  ungroup()

h2_medians <-  dane_imputed %>%
  select(price_m2, all_of(bin_vars)) %>%
  pivot_longer(
    cols = all_of(bin_vars),
    names_to = "feature",
    values_to = "group") %>%
  filter(group %in% c("yes", "no")) %>%
  group_by(feature, group) %>%
  summarise(
    n = n(),
    median = median(price_m2),
    .groups = "drop")

h2_effect <-  dane_imputed %>%
  select(price_m2, all_of(bin_vars)) %>%
  pivot_longer(
    cols = all_of(bin_vars),
    names_to = "feature",
    values_to = "group"
  ) %>%
  filter(group %in% c("yes", "no")) %>%
  group_by(feature) %>%
  wilcox_effsize(price_m2 ~ group)

h2_results <- h2_wilcox %>%
  left_join(h2_effect, by = "feature") %>%
  left_join(h2_medians, by = "feature")

h2_pub <- h2_results %>%
  select(feature,statistic, p, p.signif,effsize, magnitude,group, n, median) %>%
  pivot_wider(
    names_from = group,
    values_from = c(n, median),
    names_glue = "{.value}_{group}") %>%
  mutate(
    median_no  = round(median_no, 2),
    median_yes = round(median_yes, 2),
    effsize    = round(effsize, 3),
    p          = signif(p, 4)) %>%
  select(feature,n_no, n_yes,median_no, median_yes,statistic, p, p.signif,effsize, magnitude)
h2_pub <- h2_pub %>%
  mutate(feature = label_vars(feature))
```

```{r warning=FALSE, results='asis', echo=FALSE}
kable(
  h2_pub,
  format = "html",
  caption = "H2: Porównanie ceny za m² między mieszkaniami z cechą standardu i bez (test U Manna–Whitneya)",
  col.names = c(
    "Cecha", "Ilość (bez)", "Ilość (z)",
    "Mediana (bez)", "Mediana (z)",
    "W", "p-value", "",
    "r", "Wielkość efektu"
  ),
  digits = 2
) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover")) %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(7, bold = TRUE) %>%
  scroll_box(width = "100%", height = "350px")
```

Mieszkania wyposażone w wybrane elementy standardu (winda, ochrona, komórka lokatorska) osiągają istotnie wyższe ceny za m² niż mieszkania bez tych udogodnień. Wielkości efektu są niewielkie, ale statystycznie istotne, co wskazuje na systematyczny, choć umiarkowany wpływ standardu.

```{r warning=FALSE, include=FALSE}
h3_results <- dane_imputed %>%
  select(centreDistance, price_m2, all_of(bin_vars)) %>%
  pivot_longer(
    cols = all_of(bin_vars),
    names_to = "feature",
    values_to = "group"
  ) %>%
  filter(group %in% c("yes", "no")) %>%
  group_by(feature, group) %>%
  cor_test(centreDistance, price_m2, method = "spearman") %>%
  ungroup()

# 3) Tabela do raportu: 1 wiersz na cechę
h3_pub <- h3_results %>%
  transmute(
    feature,
    group,
    rho = round(cor, 2),
    p   = signif(p, 3)
  ) %>%
  pivot_wider(
    names_from = group,
    values_from = c(rho, p),
    names_glue = "{.value}_{group}"
  )
h3_pub <- h3_pub %>%
  mutate(feature = label_vars(feature))

h3_results
h3_pub


h3_table <- h3_pub %>%
  mutate(
    `Δρ` = round(rho_yes - rho_no, 2),
    p_no  = ifelse(p_no  < 0.001, "<0.001", format(p_no,  digits = 3)),
    p_yes = ifelse(p_yes < 0.001, "<0.001", format(p_yes, digits = 3))
  ) %>%
  select(
    Cecha = feature,
    `ρ (bez cechy)` = rho_no,
    `ρ (z cechą)`   = rho_yes,
    `Δρ`,
    `p (bez cechy)` = p_no,
    `p (z cechą)`   = p_yes
  )
```

```{r warning=FALSE, results='asis', echo=FALSE}
kable(
  h3_table,
  format = "html",
  escape = FALSE,
  caption = "H3: H3: Zależność odległości od centrum i ceny za m² w grupach standardu (korelacja Spearmana)"
) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed")) %>%
  column_spec(2:4, bold = TRUE)
```

Siła zależności między odległością od centrum a ceną za m² różni się pomiędzy grupami standardu, jednak różnice te są niewielkie i nie zawsze istotne statystycznie. Sugeruje to, że standard techniczny wpływa głównie na poziom ceny, a nie na siłę efektu lokalizacji.

## Modele regresji

Regresja liniowa stanowi jedno z podstawowych narzędzi analizy ekonometrycznej wykorzystywanych do badania zależności pomiędzy cechami nieruchomości a ich ceną. W kontekście rynku mieszkaniowego modele regresji hedonicznej pozwalają na dekompozycję ceny mieszkania na wkłady poszczególnych atrybutów, takich jak lokalizacja, cechy strukturalne lokalu oraz elementy standardu technicznego.

Proces budowy modeli regresji w niniejszym badaniu ma charakter sekwencyjny. W pierwszym kroku estymowany jest model bazowy, uwzględniający wyłącznie kluczowy czynnik lokalizacyjny – odległość mieszkania od centrum miasta. Następnie specyfikacja modelu jest stopniowo rozszerzana o zmienne strukturalne (m.in. metraż, liczba pokoi, rok budowy, piętro), zmienne opisujące otoczenie oraz cechy standardu technicznego. Takie podejście umożliwia ocenę przyrostu dopasowania modelu oraz zmian istotności poszczególnych parametrów wraz z rozszerzaniem zbioru zmiennych objaśniających.

Ze względu na obserwowaną skośność rozkładów cen oraz części zmiennych objaśniających, zastosowano transformacje logarytmiczne, co pozwala na stabilizację wariancji reszt oraz interpretację współczynników w kategoriach elastyczności. Dodatkowo, w wybranych specyfikacjach uwzględniono składniki interakcyjne, których celem było sprawdzenie, czy standard techniczny mieszkań modyfikuje siłę wpływu lokalizacji na poziom cen.

Ocena jakości modeli opiera się na analizie miar dopasowania (R² i skorygowanego R²), błędu standardowego reszt, kryteriów informacyjnych oraz diagnostyce założeń modelu, w tym współliniowości i heteroskedastyczności. Na tej podstawie wybrano końcową specyfikację modelu, która łączy dobrą interpretowalność z satysfakcjonującym poziomem dopasowania do danych empirycznych.

```{r warning=FALSE, include=FALSE}
df <- dane_imputed %>%
  mutate(
    ln_price_m2 = log(price_m2),
    ln_centre = log1p(centreDistance),   
    ln_poi = log1p(poiCount),
    ln_area = log(squareMeters),
    rooms = factor(rooms),
    type = factor(type),
    ownership = factor(ownership),
    hasElevator     = factor(hasElevator, levels = c("no","yes")),
    hasSecurity     = factor(hasSecurity, levels = c("no","yes")),
    hasStorageRoom  = factor(hasStorageRoom, levels = c("no","yes")),
    hasBalcony      = factor(hasBalcony, levels = c("no","yes")),
    hasParkingSpace = factor(hasParkingSpace, levels = c("no","yes"))) %>%
  filter(
    is.finite(ln_price_m2),
    is.finite(ln_centre),
    is.finite(ln_area),
    !is.na(buildYear),
    !is.na(floor),
    !is.na(floorCount))


m0 <- lm(ln_price_m2 ~ ln_centre, data = df)
summary(m0)
coeftest(m0, vcov = vcovHC(m0, "HC1"))

m1 <- lm(ln_price_m2 ~ ln_centre + ln_area + rooms +buildYear + floor + floorCount,data = df)
summary(m1)
coeftest(m1, vcov = vcovHC(m1, "HC1"))
vif(m1)

m2 <- lm(ln_price_m2 ~ ln_centre + ln_area + rooms +buildYear + floor + floorCount +ln_poi + schoolDistance + restaurantDistance,data =df)
summary(m2)
coeftest(m2, vcov = vcovHC(m2, "HC1"))
vif(m2)

m3 <- lm(ln_price_m2 ~ ln_centre + ln_area + rooms +buildYear + floor + floorCount +ln_poi + schoolDistance + restaurantDistance+hasElevator + hasBalcony + hasSecurity +hasStorageRoom + hasParkingSpace,data = df)
summary(m3)
coeftest(m3, vcov = vcovHC(m3, "HC1"))
vif(m3)

m4 <- lm(ln_price_m2 ~ ln_centre + ln_area + rooms +buildYear + floor + floorCount +ln_poi + schoolDistance + restaurantDistance+hasElevator + hasSecurity + hasStorageRoom +ln_centre:hasElevator +ln_centre:hasStorageRoom,data = df)
summary(m4)
coeftest(m4, vcov = vcovHC(m4, type = "HC1"))
bptest(m4)
vif(m4)
m_final <- lm( ln_price_m2 ~ ln_centre +ln_area +buildYear +floor +ln_poi +hasElevator +hasStorageRoom+ ln_centre:hasElevator+ln_centre:hasStorageRoom,data = df)
summary(m_final)
coeftest(m_final, vcov = vcovHC(m_final, "HC1"))
vif(m_final)
model_summary_extended <- tibble::tibble(
  Model = c("Model 0", "Model 1", "Model 2", "Model 3", "Model 4", "Model Final"),
  `R² (adj)` = c(
    round(summary(m0)$adj.r.squared, 3),
    round(summary(m1)$adj.r.squared, 3),
    round(summary(m2)$adj.r.squared, 3),
    round(summary(m3)$adj.r.squared, 3),
    round(summary(m4)$adj.r.squared, 3),
    round(summary(m_final)$adj.r.squared, 3)
  ),
  `Błąd standardowy` = c(
    round(sigma(m0), 3),
    round(sigma(m1), 3),
    round(sigma(m2), 3),
    round(sigma(m3), 3),
    round(sigma(m4), 3),
    round(sigma(m_final), 3)
  ),
  AIC = c(
    AIC(m0),
    AIC(m1),
    AIC(m2),
    AIC(m3),
    AIC(m4),
    AIC(m_final)
  ),
  BIC = c(
    BIC(m0),
    BIC(m1),
    BIC(m2),
    BIC(m3),
    BIC(m4),
    BIC(m_final)
  ),
  `Log-Likelihood` = c(
    logLik(m0),
    logLik(m1),
    logLik(m2),
    logLik(m3),
    logLik(m4),
    logLik(m_final)
  ),
  `Liczba obserwacji` = c(
    nobs(m0),
    nobs(m1),
    nobs(m2),
    nobs(m3),
    nobs(m4),
    nobs(m_final)
  ),
  `Liczba zmiennych` = c(
    length(coef(m0)),
    length(coef(m1)),
    length(coef(m2)),
    length(coef(m3)),
    length(coef(m4)),
    length(coef(m_final))
  ),
  `VIF > 5` = c(
    NA,
    sum(vif(m1) > 5),
    sum(vif(m2) > 5),
    sum(vif(m3) > 5),
    sum(vif(m4) > 5),
    sum(vif(m_final) > 5)))
```

### Regresja hedoniczna – konstrukcja modeli i interpretacja wyników

Celem analizy było oszacowanie wpływu lokalizacji, cech fizycznych mieszkania oraz elementów standardu technicznego na cenę mieszkań w Gdańsku, a także sprawdzenie, czy wybrane cechy standardu modyfikują zależność między odległością od centrum a ceną mieszkania. W tym celu zastosowano regresję hedoniczną, która jest standardowym narzędziem w badaniach rynku nieruchomości.

Zmienną objaśnianą we wszystkich modelach była logarytmiczna cena za metr kwadratowy mieszkania . Zastosowanie transformacji logarytmicznej pozwala ograniczyć problem heteroskedastyczności oraz umożliwia interpretację współczynników w kategoriach przybliżonych zmian procentowych.

**Model 1 – efekt lokalizacji (model bazowy)**

Pierwszy model uwzględniał wyłącznie odległość mieszkania od centrum miasta, zapisaną w postaci logarytmu:

$$
\\ln({price\_m^2}) = \beta_0 + \beta_1ln(\text{centreDistance}) + \varepsilon
$$


Wyniki wskazują na istotny statystycznie i ujemny wpływ odległości od centrum na cenę za metr kwadratowy. Oznacza to, że wzrost odległości od centrum o 1% wiąże się średnio ze spadkiem ceny za m² o około 0,12%. Rezultat ten jest zgodny z teorią renty gruntowej oraz wcześniejszymi badaniami empirycznymi dotyczącymi rynków mieszkaniowych.

Niska wartość współczynnika determinacji (R² ≈ 7%) nie stanowi wady modelu, lecz potwierdza, że sama lokalizacja nie jest wystarczająca do wyjaśnienia zróżnicowania cen mieszkań.

**Model 2 – cechy fizyczne i strukturalne mieszkania**

W kolejnym kroku do modelu dodano zmienne opisujące cechy fizyczne i techniczne budynku: metraż mieszkania (w postaci logarytmu), liczbę pokoi, rok budowy oraz położenie mieszkania w budynku (piętro i liczba kondygnacji).

Dodanie tych zmiennych istotnie poprawiło dopasowanie modelu (R² ≈ 20%). Efekt odległości od centrum pozostał stabilny i istotny statystycznie, co świadczy o jego niezależnym wpływie na ceny mieszkań.

Wyniki pokazują, że:

-   liczba pokoi ma ujemny wpływ na cenę za m² – mieszkania z większą liczbą pokoi są przeciętnie tańsze w przeliczeniu na metr kwadratowy,
-   rok budowy ma dodatni i silny wpływ na cenę – nowsze budynki są wyżej wyceniane,
-   wpływ samego metrażu po uwzględnieniu liczby pokoi okazał się statystycznie nieistotny, co sugeruje częściowe dublowanie informacji zawartej w obu zmiennych.

**Model 3 – otoczenie i dostępność usług**

Trzeci model rozszerzono o zmienne opisujące dostępność usług i infrastruktury miejskiej. Zastosowano zagregowaną miarę liczby punktów użyteczności publicznej (POI) w otoczeniu mieszkania oraz wybrane odległości do usług.

Liczba punktów POI, po transformacji logarytmicznej, okazała się silnie dodatnio skorelowana z ceną mieszkań. Oznacza to, że większa dostępność usług i infrastruktury miejskiej podnosi atrakcyjność lokalizacji i znajduje odzwierciedlenie w wyższych cenach.

Jednocześnie zauważono, że poszczególne miary odległości do usług są ze sobą silnie skorelowane, co prowadzi do problemu współliniowości. W dalszych etapach analizy zdecydowano się pozostawić jedynie odległość od centrum oraz zagregowaną miarę POI jako reprezentatywne zmienne lokalizacyjne.

**Model 4 – standard techniczny mieszkania**

Czwarty model uwzględniał binarne zmienne opisujące standard techniczny mieszkania, takie jak obecność windy, ochrony czy komórki lokatorskiej.

Wyniki wskazują, że:

-   obecność windy oraz ochrony istotnie podnosi cenę za m²,
-   efekt komórki lokatorskiej jest ujemny, co może wynikać z jej częstszego występowania w starszych budynkach o niższym standardzie,
-   balkon i miejsce parkingowe nie wykazały istotnego wpływu po uwzględnieniu pozostałych cech.

Oznacza to, że nie wszystkie elementy standardu są niezależnie wyceniane przez rynek.

**Model 5 – interakcje (test hipotezy głównej)**

Ostatni model miał na celu bezpośrednie przetestowanie hipotezy głównej poprzez wprowadzenie interakcji pomiędzy odległością od centrum a wybranymi cechami standardu technicznego (winda, komórka lokatorska). 
$$
\begin{aligned}
\\ln({price\_m^2}) =\;& \beta_0
+ \beta_1 \ln(\text{centre})
+ \beta_2 \ln(\text{area})
+ \beta_3 \text{buildYear}
+ \beta_4 \text{floor} \\
&+ \beta_5 \ln(\text{poi})
+ \beta_6 \text{hasElevator}
+ \beta_7 \text{hasStorageRoom} \\
&+ \beta_8 \bigl(\ln(\text{centre}) \cdot \text{hasElevator}\bigr)
+ \beta_9 \bigl(\ln(\text{centre}) \cdot \text{hasStorageRoom}\bigr)
+ \varepsilon
\end{aligned}
$$


Choć znaki współczynników interakcji były zgodne z intuicją ekonomiczną, nie uzyskano jednoznacznej istotności statystycznej. Oznacza to, że standard techniczny nie zmienia w sposób istotny siły zależności między lokalizacją a ceną mieszkania, lecz wpływa głównie na poziom ceny.

```{r warning=FALSE, results='asis', echo=FALSE}
model_summary_extended %>%
  kable(
    format = "html",
    caption = "Podsumowanie wyników regresji – różne modele",
    col.names = c("Model", "R² (adj)", "Błąd standardowy", "AIC", "BIC", "Log-Likelihood", "Liczba obserwacji", "Liczba zmiennych", "VIF > 5")
  ) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed")) %>%
  row_spec(0, bold = TRUE, background = "#D3D3D3") %>%
  column_spec(2:5, bold = TRUE) %>%
  column_spec(9, color = "red") 
```

Przeprowadzona analiza potwierdziła istnienie silnej i stabilnej zależności między odległością od centrum miasta a ceną mieszkań w Gdańsku. Lokalizacja pozostaje jednym z kluczowych czynników kształtujących ceny, nawet po uwzględnieniu cech fizycznych, otoczenia oraz standardu technicznego.

Cechy standardu technicznego, takie jak winda czy ochrona, istotnie podnoszą poziom cen mieszkań, jednak nie modyfikują w sposób istotny wpływu odległości od centrum. Oznacza to, że standard działa głównie jako premia cenowa, a nie jako czynnik kompensujący gorszą lokalizację.

Hipoteza główna zakładająca łagodzenie negatywnego wpływu odległości od centrum przez standard techniczny nie została jednoznacznie potwierdzona. Jednocześnie hipotezy pomocnicze dotyczące wpływu lokalizacji, dostępności usług oraz cech technicznych na poziom cen znalazły potwierdzenie w wynikach empirycznych.

Uzyskane rezultaty wskazują, że dalsze badania mogłyby uwzględniać segmentację rynku (np. nowe i stare budownictwo) lub analizę dynamiczną opartą na danych z różnych okresów, co umożliwiłoby konstrukcję indeksu hedonicznego cen mieszkań.

## Podsumowanie

Celem pracy była analiza czynników wpływających na ceny mieszkań w mieście Gdańsk, ze szczególnym uwzględnieniem roli lokalizacji oraz wybranych cech standardu technicznego. Badanie przeprowadzono na podstawie danych ofertowych z wykorzystaniem metod eksploracyjnych, wnioskowania statystycznego oraz regresji hedonicznej w środowisku R.

W pierwszym etapie dokonano przygotowania danych, obejmującego walidację logiczną obserwacji, identyfikację wartości odstających oraz imputację braków danych metodą MICE. Zastosowane procedury zapewniły spójność i jakość zbioru danych wykorzystywanego w dalszych analizach.

Analiza korelacji rang Spearmana wykazała istotną, ujemną zależność pomiędzy odległością mieszkania od centrum miasta a ceną całkowitą oraz ceną za metr kwadratowy. Potwierdzono również dodatnią zależność pomiędzy metrażem a ceną całkowitą oraz słabszą, ujemną zależność pomiędzy metrażem a ceną jednostkową. Wyniki te są zgodne z intuicją ekonomiczną oraz obserwacjami rynku nieruchomości.

Testy U Manna–Whitneya potwierdziły, że mieszkania wyposażone w wybrane udogodnienia techniczne, takie jak winda czy miejsce parkingowe, osiągają istotnie wyższe ceny za metr kwadratowy niż lokale ich pozbawione. Jednocześnie analiza korelacji w grupach standardu nie dostarczyła jednoznacznych dowodów na to, że cechy techniczne istotnie modyfikują zależność pomiędzy odległością od centrum a ceną.

W końcowym etapie zbudowano modele regresji hedonicznej, stopniowo rozszerzając ich specyfikację o zmienne strukturalne, lokalizacyjne oraz cechy standardu technicznego. Wraz z rozbudową modeli obserwowano poprawę dopasowania, jednak interakcje pomiędzy odległością od centrum a cechami standardu nie wykazały jednoznacznej istotności statystycznej. Ostateczny model charakteryzuje się dobrą interpretowalnością i stabilnością estymacji, potwierdzając dominującą rolę lokalizacji w kształtowaniu cen mieszkań w Gdańsku.

Uzyskane wyniki wskazują, że standard techniczny mieszkań wpływa głównie na poziom cen, natomiast nie zmienia istotnie siły oddziaływania lokalizacji. Przeprowadzona analiza stanowi solidną podstawę do dalszych badań ekonometrycznych i predykcyjnych rynku nieruchomości.
